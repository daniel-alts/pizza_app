const express = require('express');
const passport = require('passport');
const jwt = require('jsonwebtoken');
require('dotenv').config();

// ...

const router = express.Router();


router.post(
    '/signup',
    passport.authenticate('signup', { session: false }), async (req, res, next) => {
        res.status(201).json({
            message: 'Signup successful',
            user: req.user
        });
    }

)
  router.post(
    '/login', async (req, res, next) => {
    passport.authenticate('login',async (err, user, info) => {
        try {
          if (err || !user) {
            const error = new Error('An error occurred.');

            return next(error);
          }

          req.login(
            user,
            { session: false },
            async (error) => {
              if (error) return next(error);

              const body = { _id: user._id, email: user.email };
              const token = jwt.sign({ user: body }, process.env.JWT_SECRET, { expiresIn: '1h' });

              return res.json({ token });
            }
          );
        } catch (error) {
          return next(error);
        }
      }
    )(req, res, next);
  }

  )
module.exports = router;

module.exports = router;









// const express = require("express")
// const bcrypt = require('bcrypt');
// const authenticateUser = require("../middleware/auth");
// const User= require('../models/userModels');

// const saltRounds = 10;

// exports.register = async(req, res) => {
//     try {
//         let user = await User.findOne({
//             username:req.body.username
//            // password:req.body.password
//         })
//             if(user) {
//                 return res.status(400).send('User already exists. Kindly login')
//             }
//         const hashedPassword = await bcrypt.hash(req.body.password,saltRounds);
//          user = new User.create({
//             username: req.body.username,
//             password: hashedPassword,
//             user_type: req.body.user_type
//         })
//         await user.save()
//         res.send("Registration Successful")
//     } catch (error) {
//         res.status(500).send("Internal Server Error occurred")
//     }
// }

// exports.login = async(req, res) => {
//     try {
//         const{ username, password } = req.body
//         const user = await User.findOne({ username: req.body.username })
//         const hashedPassword = await bcrypt.hash(req.body.password,saltRounds);
        
//         if (user) {
//             const comparePwd = await bcrypt.compare(password, hashedPassword)
//             if(comparePwd) {
//                 res.status(200).json(user)
//             }
//            // res.send("Invalid Details")
//         } else if(!user){
//             res.send("Wrong username or password.")
//         }
//     } catch (error) {
//         console.log(error)
//         res.status(500).send("Internal Server error occured")
//     }
// }


//     exports.getAllUsers = async (req, res) => {
//         try {
//             //let id = {_id: req.param.id}
//            //  const authUser = req.authUser 
//          const user = await User.find({   })
//              // if(!authUser.role !==)
//               if (user == null ) {
//                   return res.status(400).send("User not found!")
//               } 
//                   return res.status(200).json({
//                     succes: true,
//                     message:"user found!",
//                     user,
                    
//                 })
              
      
        
//       } catch (error) {
//         res.status(500).json({
//             success: false,
//             message: "Internal Server Error",
//             error: error.message
//         })
//       }
//       }
          
    
    

// exports.getUserbyId = async (req, res) => {
//     try {
//         let id = {_id: req.param.id}
//       const user = await User.findOne({ id })
          
//           if (user == null ) {
//               return res.status(400).send("User not found!")
//           } 
//               return res.status(200).json({
//                 succes: true,
//                 message:"user found!",
//                 user
//             })
          
  
    
//   } catch (error) {
//     console.log(error)
//     res.catch(500).json({
        
//         success: false,
//         message: "Internal Server Error",
//         error: error.message
//     })
//   }
//   }
      

  
// exports.updateUser = async (req, res) => {
//     try {
//         let id = {_id: req.params.id}
//         let user = await req.body
//       const update = await User.findOneAndUpdate( id, user, {new: true} )
          
//           if (update == null ) {
//               return res.status(400).send("User not updated!")
//           } 
//               return res.status(200).json({
//                 succes: true,
//                 message:"user updated Successfully!",
//                 user: update
//             })
          
  
    
//   } catch (error) {
//     res.catch(500).json({
//         success: false,
//         message: "Internal Server Error",
//         error: error.message
//     })
//   }
//   }


  
// exports.deleteUser = async (req, res) => {
//     try {
//         let id = {_id: req.params.id}
//       let removeUser = await User.findOneAndRemove(id)
          
//           if (removeUser == null ) {
//               return res.status(400).send("User not deleted!")
//           } 
//               return res.status(200).json({
//                 succes: true,
//                 message:"Deleted!",

//             })
          
  
    
//   } catch (error) {
//     res.catch(500).json({
//         success: false,
//         message: "Internal Server Error",
//         error: error.message
//     })
//   }
//   }
      
  
  
      


  
  